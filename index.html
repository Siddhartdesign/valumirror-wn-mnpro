
  <!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>ValueMirror Pro</title>
<style>
:root{
  --bg:#090909; --accent:#d4a373; --text:#fff; --ui-bg:rgba(15,15,15,0.95);
}
*{box-sizing:border-box; -webkit-tap-highlight-color:transparent;}
html,body{height:100%; margin:0; background:var(--bg); color:var(--text); font-family:-apple-system,system-ui,sans-serif; overflow:hidden;}
.app{position:relative; width:100vw; height:100vh;}
 
video, canvas { position:absolute; inset:0; width:100%; height:100%; object-fit:contain; }
#camera{z-index:1;}
#frozen{z-index:2; display:none;}
#massing{z-index:3; display:none;}
#overlay{z-index:4; pointer-events:none;}
 
.ui{
  position:absolute; inset:0; z-index:10; 
  display:flex; flex-direction:column; justify-content:space-between;
  pointer-events:none;
}
 
.top-bar {
  padding: 6px; display: flex; overflow-x: auto; gap: 6px; pointer-events:auto;
  background: linear-gradient(to bottom, rgba(0,0,0,0.9), transparent);
  scrollbar-width: none;
}
.top-bar::-webkit-scrollbar { display: none; }

.icon-btn{
  flex: 0 0 auto;
  background:rgba(255,255,255,0.12); border:1px solid rgba(255,255,255,0.1); border-radius:8px;
  width:60px; height:52px; display:flex; flex-direction:column; justify-content:center; align-items:center;
  cursor:pointer; color:#fff; transition: all 0.2s;
}
.wide { width: 72px; }

.icon-btn.active { background: var(--accent); color: #000; border-color: var(--accent); }
.icon-label{ font-size:8px; margin-top:3px; font-weight:800; text-transform:uppercase; text-align:center; line-height:1; }
 
.controls{
  pointer-events:auto; padding:12px; padding-bottom: calc(12px + env(safe-area-inset-bottom));
  background: var(--ui-bg); backdrop-filter:blur(25px);
  display:flex; flex-direction:column; gap:8px;
  border-top: 1px solid rgba(255,255,255,0.1);
}
 
.mode-group{ display:flex; background:rgba(255,255,255,0.05); padding:3px; border-radius:8px; }
.mode-group button{
  flex:1; border:none; background:transparent; padding:9px;
  border-radius:5px; font-size:11px; color:#888; cursor:pointer; font-weight:700;
}
.mode-group button.active{ background:#fff; color:#000; }

.tab-and-save-row{
  display:flex; gap:6px; align-items:stretch;
}
.mode-tabs{
  flex:1; display:flex; background:rgba(255,255,255,0.05); padding:3px; border-radius:8px; gap:2px;
}
.mode-tabs button{
  flex:1; border:none; background:transparent; padding:9px;
  border-radius:5px; font-size:11px; color:#888; cursor:pointer; font-weight:700;
  transition: all 0.15s;
}
.mode-tabs button.active{ background:#fff; color:#000; }

.save-btn-small{
  background:var(--accent); border:none; border-radius:8px;
  padding:9px 12px; font-weight:800; cursor:pointer; font-size:11px; color:#000;
  white-space:nowrap; min-width:70px;
}
 
.range-box { display:flex; flex-direction:column; gap:3px; }
.range-box label { display:flex; justify-content:space-between; font-size:9px; color:var(--accent); font-weight:800; }
.range{ width:100%; accent-color:var(--accent); height:24px; }

.fullscreen-overlay {
  position:fixed; inset:0; z-index:200; background:#000; display:none;
  align-items:center; justify-content:center;
}
.fullscreen-overlay.active { display:flex; }
.fullscreen-image { max-width:100%; max-height:100%; object-fit:contain; }
.back-btn {
  position:absolute; top:20px; left:20px; background:rgba(255,255,255,0.12);
  border:1px solid rgba(255,255,255,0.2); border-radius:8px; padding:12px 20px;
  color:rgba(255,255,255,0.6); font-size:13px; font-weight:700; cursor:pointer;
  transition: all 0.2s; opacity:0.7;
}
.back-btn:hover { background:rgba(255,255,255,0.2); color:rgba(255,255,255,0.9); opacity:1; }

.menu-modal{
  position:fixed; inset:0; z-index:100; display:none; background:rgba(0,0,0,0.85); backdrop-filter:blur(10px);
  align-items:center; justify-content:center; pointer-events:auto;
}
.menu-modal.active{ display:flex; }
.menu-content{
  background:var(--ui-bg); border-radius:16px; padding:24px; max-width:400px; width:90%;
  border:1px solid rgba(255,255,255,0.1); max-height:80vh; overflow-y:auto;
}
.menu-header{ font-size:20px; font-weight:800; color:var(--accent); margin-bottom:20px; text-align:center; }
.menu-section{ margin-bottom:20px; }
.menu-section-title{ font-size:16px; font-weight:800; color:#888; margin-bottom:12px; text-transform:uppercase; letter-spacing:0.5px; }
.menu-item{ font-size:14px; color:var(--accent); margin:10px 0; line-height:1.6; cursor:pointer; font-weight:700; }
.menu-item:hover{ opacity:0.8; }
.menu-divider{ height:1px; background:rgba(255,255,255,0.1); margin:16px 0; }
.close-menu-btn{
  background:var(--accent); border:none; border-radius:10px; padding:14px;
  font-weight:800; width:100%; cursor:pointer; font-size:13px; color:#000; margin-top:12px;
}
.expandable-content{ 
  max-height:0; overflow:hidden; transition:max-height 0.3s ease;
  margin-top:8px;
}
.expandable-content.open{ max-height:500px; }
.how-to-list{ margin-top:8px; padding-left:20px; }
.how-to-list li{ margin:8px 0; font-size:12px; color:#ddd; line-height:1.5; }
.how-to-note{ font-size:11px; color:#999; font-style:italic; margin-top:12px; line-height:1.5; }
.whats-new-list{ margin-top:10px; }
.feature-item{ 
  margin:10px 0; font-size:12px; color:#bbb; line-height:1.6; 
  padding-left:4px;
}

.compare-hint {
  position:absolute; top:80px; left:50%; transform:translateX(-50%);
  background:rgba(0,0,0,0.7); padding:8px 16px; border-radius:6px;
  font-size:13px; color:#aaa; pointer-events:none; opacity:0;
  transition: opacity 0.3s;
}
.compare-hint.show { opacity:1; }

.compare-dot {
  position:absolute; width:12px; height:12px; border-radius:50%;
  background:rgba(255,255,255,0.4); border:2px solid rgba(255,255,255,0.6);
  transform:translate(-50%, -50%); pointer-events:none; z-index:15;
}

.compare-result {
  position:absolute; background:rgba(0,0,0,0.85); padding:16px 20px;
  border-radius:10px; border:1px solid rgba(255,255,255,0.2);
  pointer-events:none; z-index:15; transform:translate(-50%, -120%);
  min-width:120px; text-align:center;
}
.compare-primary {
  font-size:24px; font-weight:900; margin-bottom:4px;
}
.compare-primary.lighter { color:#fff; }
.compare-primary.darker { color:#666; }
.compare-primary.same { color:#aaa; }
.compare-secondary {
  font-size:12px; color:#888; font-weight:400;
}
</style>
</head>
 
<body>
<div class="app">
  <video id="camera" autoplay playsinline muted></video>
  <canvas id="frozen"></canvas>
  <canvas id="massing"></canvas>
  <canvas id="overlay"></canvas>
 
  <div id="compare-hint" class="compare-hint">Tap first area</div>

  <div class="ui">
    <div class="top-bar">
        <button id="menu-btn" class="icon-btn">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M3 12h18M3 6h18M3 18h18"/></svg>
          <div class="icon-label">Menu</div>
        </button>
        <button id="import-btn" class="icon-btn wide">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" transform="scale(1,-1)"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M17 8l-5-5-5 5M12 3v12"/></svg>
          <div class="icon-label">Import</div>
        </button>
        <button id="simplify-btn" class="icon-btn wide">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="12" cy="12" r="10"/></svg>
          <div class="icon-label" id="squint-label">SQUINT: OFF</div>
        </button>
        <button id="compare-btn" class="icon-btn">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
            <circle cx="9" cy="12" r="6"/>
            <circle cx="15" cy="12" r="6"/>
          </svg>
          <div class="icon-label">Compare</div>
        </button>
        <button id="outlines-btn" class="icon-btn">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M12 3v18M3 12h18"/></svg>
          <div class="icon-label" id="edge-label">Edges</div>
        </button>
        <button id="flip-h-btn" class="icon-btn">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M4 12h16M8 6l-4 6 4 6"/></svg>
          <div class="icon-label">Flip H</div>
        </button>
        <button id="flip-v-btn" class="icon-btn">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" transform="rotate(90)"><path d="M4 12h16M8 6l-4 6 4 6"/></svg>
          <div class="icon-label">Flip V</div>
        </button>
        <button id="isolate-btn" class="icon-btn">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><rect x="4" y="4" width="6" height="6"/><rect x="14" y="4" width="6" height="6"/><rect x="4" y="14" width="6" height="6"/><rect x="14" y="14" width="6" height="6"/></svg>
          <div class="icon-label">Isolate</div>
        </button>
        <button id="grid-btn" class="icon-btn">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><rect x="3" y="3" width="18" height="18"/><path d="M3 9h18M3 15h18M9 3v18M15 3v18"/></svg>
          <div class="icon-label">Grid</div>
        </button>
        <button id="histogram-btn" class="icon-btn">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M3 20h18M5 20V10m4 10V4m4 16v-9m4 9V6"/></svg>
          <div class="icon-label">Stats</div>
        </button>
        <button id="fullscreen-btn" class="icon-btn">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"/></svg>
          <div class="icon-label">Full</div>
        </button>
    </div>
 
    <div class="controls">
      <div class="tab-and-save-row">
        <div class="mode-tabs">
          <button id="live-btn">Live</button>
          <button id="grayscale-btn">B&W</button>
          <button id="simplify-tab">Tones</button>
        </div>
        <button id="snapshot" class="save-btn-small">SAVE</button>
      </div>
 
      <div class="range-box" id="simplify-box" style="display:none;">
        <label>
          <span>TONES</span>
          <span id="massing-val">12</span>
        </label>
        <input type="range" id="massing" class="range" min="2" max="50" value="12">
      </div>
 
      <div class="range-box" id="isolate-box" style="display:none;">
        <label>
          <span>ISOLATE VALUE</span>
          <span id="val-num">50</span>
        </label>
        <input type="range" id="isolate-slider" class="range" min="0" max="100" value="50">
      </div>
 
      <div class="range-box" id="grid-box" style="display:none;">
        <label>
          <span>GRID DIVISIONS</span>
          <span id="grid-val">3</span>
        </label>
        <input type="range" id="grid-slider" class="range" min="2" max="10" value="3">
      </div>
 
      <div class="range-box">
        <label>
          <span>DIMMING</span>
          <span id="dim-val">50%</span>
        </label>
        <input type="range" id="dim" class="range" min="0" max="100" value="50">
      </div>
 
      <button id="reset-btn" style="background:rgba(255,255,255,0.1); border:1px solid rgba(255,255,255,0.1); color:#fff; padding:12px; border-radius:8px; cursor:pointer; font-weight:800; font-size:11px;">RESET ALL</button>
    </div>
  </div>
</div>
 
<div id="fullscreen-overlay" class="fullscreen-overlay">
  <button id="back-btn" class="back-btn">‚Üê Back</button>
  <canvas id="fullscreen-canvas"></canvas>
</div>
 
<div id="menu-modal" class="menu-modal">
  <div class="menu-content">
    <div class="menu-header">ValueMirror Pro</div>
 
    <div class="menu-section">
      <div id="how-to-toggle" class="menu-item">üìñ How to Use</div>
      <div id="how-to-content" style="display:none;">
        <ol class="how-to-list">
          <li><strong>Import</strong> a photo or use your device camera</li>
          <li>Use <strong>Live / B&W / Tones</strong> tabs to switch views</li>
          <li><strong>Tones</strong> slider reduces image to simplified values</li>
          <li><strong>Isolate</strong> shows only one specific value range</li>
          <li><strong>Grid</strong> overlays reference lines for composition</li>
          <li><strong>Dimming</strong> adjusts overall brightness for tracing</li>
          <li><strong>Flip H/V</strong> mirrors image horizontally or vertically</li>
          <li><strong>Compare</strong> tap two areas to see value difference</li>
          <li><strong>Edges</strong> cycles through edge detection modes</li>
          <li><strong>Squint</strong> applies blur for simplified viewing</li>
          <li><strong>Save</strong> exports your current view as PNG</li>
        </ol>
        <p class="how-to-note">Tip: Use TONES mode to see major value shapes. Use ISOLATE to study specific value ranges.</p>
      </div>
    </div>
 
    <div class="menu-divider"></div>
 
    <div class="menu-section">
      <div class="menu-section-title">What's New</div>
      <div class="whats-new-list">
        <div class="feature-item">‚ú® <strong>Compare Tool</strong> - Tap two areas to see value difference</div>
        <div class="feature-item">üé® <strong>Edge Detection</strong> - Three modes: Off / Edges Only / Edges + Values</div>
        <div class="feature-item">üëÅÔ∏è <strong>Squint Mode</strong> - Blur effect for simplified viewing</div>
        <div class="feature-item">üì± <strong>Improved Mobile UI</strong> - Better touch controls and layout</div>
      </div>
    </div>
 
    <div class="menu-divider"></div>
 
    <div class="menu-section">
      <div id="feedback-btn" class="menu-item">üí¨ Feedback & Contact</div>
      <div id="feedback-email" style="display:none; margin-top:10px; font-size:12px; color:#bbb;">
        <p>Questions, bugs, or feature requests?</p>
        <p style="color:var(--accent); font-weight:700;">sidartdesign@gmail.com</p>
      </div>
    </div>
 
    <button id="close-menu-btn" class="close-menu-btn">Close</button>
  </div>
</div>
 
<input type="file" id="file-input" accept="image/*" style="display:none;">
 
<script>
  const DPR = window.devicePixelRatio || 1;
  const video = document.getElementById("camera");
  const frozen = document.getElementById("frozen");
  const massing = document.getElementById("massing");
  const overlay = document.getElementById("overlay");
 
  const ctxF = frozen.getContext("2d", { willReadFrequently: true });
  const ctxM = massing.getContext("2d", { willReadFrequently: true });
  const ctxO = overlay.getContext("2d");
 
  let imported = false;
  let massingTones = 0;
  let isolateActive = false;
  let isolatedVal = 50;
  let gridOn = false;
  let gridDivisions = 3;
  let hFlip = false;
  let vFlip = false;
  let grayMode = false;
  let showEdges = false;
  let showSourceUnder = true;
  let edgeMode = 0;
  let squintMode = 0;
  let compareMode = false;
  let compareFirstPoint = null;
 
  function resize(canvas) {
    canvas.width = window.innerWidth * DPR;
    canvas.height = window.innerHeight * DPR;
    canvas.style.width = window.innerWidth + "px";
    canvas.style.height = window.innerHeight + "px";
  }
 
  resize(frozen);
  resize(massing);
  resize(overlay);
 
  navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
    .then(stream => { video.srcObject = stream; })
    .catch(() => { });
 
  function applyTransform() {
    const scaleX = hFlip ? -1 : 1;
    const scaleY = vFlip ? -1 : 1;
    const tx = hFlip ? "100%" : "0";
    const ty = vFlip ? "100%" : "0";
    const t = `translate(${tx}, ${ty}) scale(${scaleX}, ${scaleY})`;
    video.style.transform = t;
    frozen.style.transform = t;
    massing.style.transform = t;
  }
 
  function draw(ctx, source, w, h) {
    ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
    const sw = source.videoWidth || source.width;
    const sh = source.videoHeight || source.height;
    if (!sw || !sh) return;
    const scale = Math.min(w / sw, h / sh);
    const dw = sw * scale;
    const dh = sh * scale;
    const dx = (w - dw) * 0.5;
    const dy = (h - dh) * 0.5;
    ctx.drawImage(source, dx, dy, dw, dh);
  }
 
  function gaussianBlur(imageData, radius) {
    const pixels = imageData.data;
    const width = imageData.width;
    const height = imageData.height;
    const temp = new Uint8ClampedArray(pixels);
    const kernel = createGaussianKernel(radius);
    const kernelSize = kernel.length;
    const halfKernel = Math.floor(kernelSize / 2);
    
    for (let y = 0; y < height; y++) {
      for (let x = 0; x < width; x++) {
        let r = 0, g = 0, b = 0, a = 0, weightSum = 0;
        
        for (let ky = -halfKernel; ky <= halfKernel; ky++) {
          for (let kx = -halfKernel; kx <= halfKernel; kx++) {
            const px = Math.min(width - 1, Math.max(0, x + kx));
            const py = Math.min(height - 1, Math.max(0, y + ky));
            const idx = (py * width + px) * 4;
            const weight = kernel[ky + halfKernel] * kernel[kx + halfKernel];
            
            r += temp[idx] * weight;
            g += temp[idx + 1] * weight;
            b += temp[idx + 2] * weight;
            a += temp[idx + 3] * weight;
            weightSum += weight;
          }
        }
        
        const idx = (y * width + x) * 4;
        pixels[idx] = r / weightSum;
        pixels[idx + 1] = g / weightSum;
        pixels[idx + 2] = b / weightSum;
        pixels[idx + 3] = a / weightSum;
      }
    }
    
    return imageData;
  }
 
  function createGaussianKernel(radius) {
    const size = radius * 2 + 1;
    const kernel = new Array(size);
    const sigma = radius / 2;
    let sum = 0;
    
    for (let i = 0; i < size; i++) {
      const x = i - radius;
      kernel[i] = Math.exp(-(x * x) / (2 * sigma * sigma));
      sum += kernel[i];
    }
    
    for (let i = 0; i < size; i++) {
      kernel[i] /= sum;
    }
    
    return kernel;
  }
 
  function sobelEdges(imageData) {
    const w = imageData.width;
    const h = imageData.height;
    const src = imageData.data;
    const out = new Uint8ClampedArray(src.length);
    
    const sobelX = [-1, 0, 1, -2, 0, 2, -1, 0, 1];
    const sobelY = [-1, -2, -1, 0, 0, 0, 1, 2, 1];
    
    for (let y = 1; y < h - 1; y++) {
      for (let x = 1; x < w - 1; x++) {
        let gx = 0, gy = 0;
        
        for (let ky = -1; ky <= 1; ky++) {
          for (let kx = -1; kx <= 1; kx++) {
            const idx = ((y + ky) * w + (x + kx)) * 4;
            const gray = (src[idx] + src[idx + 1] + src[idx + 2]) / 3;
            const ki = (ky + 1) * 3 + (kx + 1);
            gx += gray * sobelX[ki];
            gy += gray * sobelY[ki];
          }
        }
        
        const mag = Math.sqrt(gx * gx + gy * gy);
        const edge = Math.min(255, mag);
        const idx = (y * w + x) * 4;
        out[idx] = out[idx + 1] = out[idx + 2] = edge;
        out[idx + 3] = 255;
      }
    }
    
    return new ImageData(out, w, h);
  }
 
  function renderFrame() {
    const w = window.innerWidth * DPR;
    const h = window.innerHeight * DPR;
    const source = imported ? frozen : video;
    
    if (massingTones > 0) {
      draw(ctxM, source, w, h);
      const imgData = ctxM.getImageData(0, 0, w, h);
      const d = imgData.data;
      const step = 255 / massingTones;
      
      for (let i = 0; i < d.length; i += 4) {
        let gray = d[i] * 0.299 + d[i + 1] * 0.587 + d[i + 2] * 0.114;
        if (squintMode === 1) gray = Math.floor(gray / step) * step;
        else if (squintMode === 2) gray = Math.round(gray / step) * step;
        
        if (isolateActive) {
          const target = isolatedVal * 2.55;
          const range = step * 0.5;
          if (Math.abs(gray - target) > range) {
            d[i] = d[i + 1] = d[i + 2] = 0;
            d[i + 3] = 0;
          } else {
            d[i] = d[i + 1] = d[i + 2] = gray;
          }
        } else {
          d[i] = d[i + 1] = d[i + 2] = gray;
        }
      }
      
      if (showEdges) {
        const edges = sobelEdges(imgData);
        if (showSourceUnder) {
          for (let i = 0; i < d.length; i += 4) {
            const e = edges.data[i];
            if (e > 50) {
              d[i] = d[i + 1] = d[i + 2] = 255;
            }
          }
        } else {
          for (let i = 0; i < d.length; i += 4) {
            d[i] = d[i + 1] = d[i + 2] = edges.data[i];
          }
        }
      }
      
      ctxM.putImageData(imgData, 0, 0);
      massing.style.display = "block";
    } else {
      massing.style.display = "none";
    }
    
    ctxO.clearRect(0, 0, overlay.width, overlay.height);
    ctxO.scale(DPR, DPR);
    
    const dimVal = parseInt(document.getElementById("dim").value);
    if (dimVal > 0) {
      ctxO.fillStyle = `rgba(0,0,0,${dimVal / 100})`;
      ctxO.fillRect(0, 0, window.innerWidth, window.innerHeight);
    }
    
    if (gridOn) {
      ctxO.strokeStyle = "rgba(255,255,255,0.3)";
      ctxO.lineWidth = 1;
      const cw = window.innerWidth / gridDivisions;
      const ch = window.innerHeight / gridDivisions;
      for (let i = 1; i < gridDivisions; i++) {
        ctxO.beginPath();
        ctxO.moveTo(i * cw, 0);
        ctxO.lineTo(i * cw, window.innerHeight);
        ctxO.stroke();
        ctxO.beginPath();
        ctxO.moveTo(0, i * ch);
        ctxO.lineTo(window.innerWidth, i * ch);
        ctxO.stroke();
      }
    }
    
    const histBtn = document.getElementById("histogram-btn");
    if (histBtn.classList.contains("active")) {
      const tempCanvas = document.createElement("canvas");
      tempCanvas.width = w;
      tempCanvas.height = h;
      const tempCtx = tempCanvas.getContext("2d");
      draw(tempCtx, source, w, h);
      const imgData = tempCtx.getImageData(0, 0, w, h);
      const d = imgData.data;
      const histogram = new Array(256).fill(0);
      
      for (let i = 0; i < d.length; i += 4) {
        const gray = Math.round(d[i] * 0.299 + d[i + 1] * 0.587 + d[i + 2] * 0.114);
        histogram[gray]++;
      }
      
      const maxCount = Math.max(...histogram);
      const histW = 256;
      const histH = 100;
      const startX = window.innerWidth - histW - 20;
      const startY = window.innerHeight - histH - 20;
      
      ctxO.fillStyle = "rgba(0,0,0,0.7)";
      ctxO.fillRect(startX - 10, startY - 10, histW + 20, histH + 20);
      
      ctxO.fillStyle = "rgba(255,255,255,0.8)";
      for (let i = 0; i < 256; i++) {
        const barH = (histogram[i] / maxCount) * histH;
        ctxO.fillRect(startX + i, startY + histH - barH, 1, barH);
      }
    }
    
    ctxO.setTransform(1, 0, 0, 1, 0, 0);
    requestAnimationFrame(renderFrame);
  }
 
  renderFrame();
 
  document.getElementById("close-menu-btn").onclick = () => {
    document.getElementById("menu-modal").classList.remove("active");
  };
 
  document.getElementById("live-btn").onclick = () => {
    massingTones = 0;
    grayMode = false;
    document.getElementById("simplify-box").style.display = "none";
    document.querySelectorAll(".mode-tabs button").forEach(b => b.classList.remove("active"));
    document.getElementById("live-btn").classList.add("active");
  };
 
  document.getElementById("grayscale-btn").onclick = () => {
    massingTones = 256;
    grayMode = true;
    document.getElementById("simplify-box").style.display = "none";
    document.querySelectorAll(".mode-tabs button").forEach(b => b.classList.remove("active"));
    document.getElementById("grayscale-btn").classList.add("active");
  };
 
  document.getElementById("simplify-tab").onclick = () => {
    if (massingTones === 0 || grayMode) {
      massingTones = 12;
      grayMode = false;
    }
    document.getElementById("simplify-box").style.display = "block";
    document.querySelectorAll(".mode-tabs button").forEach(b => b.classList.remove("active"));
    document.getElementById("simplify-tab").classList.add("active");
  };
 
  document.getElementById("live-btn").classList.add("active");
 
  document.getElementById("massing").oninput = (e) => {
    massingTones = parseInt(e.target.value);
    document.getElementById("massing-val").textContent = massingTones;
  };
 
  document.getElementById("simplify-btn").onclick = () => {
    squintMode = (squintMode + 1) % 3;
    const label = document.getElementById("squint-label");
    const btn = document.getElementById("simplify-btn");
    
    if (squintMode === 0) {
      label.textContent = "SQUINT: OFF";
      btn.classList.remove("active");
    } else if (squintMode === 1) {
      label.textContent = "SQUINT: LOW";
      btn.classList.add("active");
    } else {
      label.textContent = "SQUINT: HIGH";
      btn.classList.add("active");
    }
  };

  document.getElementById("compare-btn").onclick = () => {
    compareMode = !compareMode;
    document.getElementById("compare-btn").classList.toggle("active", compareMode);
    const hint = document.getElementById("compare-hint");
    
    if (compareMode) {
      hint.classList.add("show");
      compareFirstPoint = null;
      document.querySelectorAll('.compare-dot').forEach(el => el.remove());
      document.querySelectorAll('.compare-result').forEach(el => el.remove());
    } else {
      hint.classList.remove("show");
      compareFirstPoint = null;
      document.querySelectorAll('.compare-dot').forEach(el => el.remove());
      document.querySelectorAll('.compare-result').forEach(el => el.remove());
    }
  };

  function getValueAtPoint(x, y) {
    const w = window.innerWidth * DPR;
    const h = window.innerHeight * DPR;
    const source = imported ? frozen : video;
    
    const tempCanvas = document.createElement('canvas');
    tempCanvas.width = w;
    tempCanvas.height = h;
    const tempCtx = tempCanvas.getContext('2d');
    draw(tempCtx, source, w, h);
    
    const px = Math.floor(x * DPR);
    const py = Math.floor(y * DPR);
    const imgData = tempCtx.getImageData(px, py, 1, 1);
    const d = imgData.data;
    const gray = Math.round(d[0] * 0.299 + d[1] * 0.587 + d[2] * 0.114);
    return gray;
  }

  function handleCompareClick(e) {
    if (!compareMode) return;
    
    const rect = e.currentTarget.getBoundingClientRect();
    const x = e.clientX - rect.left;
    const y = e.clientY - rect.top;
    const value = getValueAtPoint(x, y);
    const hint = document.getElementById("compare-hint");
    
    if (!compareFirstPoint) {
      compareFirstPoint = { x, y, value };
      hint.textContent = "Tap second area";
      
      const dot = document.createElement('div');
      dot.className = 'compare-dot';
      dot.style.left = x + 'px';
      dot.style.top = y + 'px';
      document.body.appendChild(dot);
    } else {
      const dot = document.createElement('div');
      dot.className = 'compare-dot';
      dot.style.left = x + 'px';
      dot.style.top = y + 'px';
      document.body.appendChild(dot);
      
      const diff = value - compareFirstPoint.value;
      const diffPercent = Math.round((diff / 255) * 100);
      
      const result = document.createElement('div');
      result.className = 'compare-result';
      result.style.left = x + 'px';
      result.style.top = y + 'px';
      
      let primaryText, primaryClass, secondaryText;
      if (Math.abs(diffPercent) <= 2) {
        primaryText = '‚ñ† Same';
        primaryClass = 'same';
        secondaryText = '(‚âà0%)';
      } else if (diff > 0) {
        primaryText = '‚ñ≤ Lighter';
        primaryClass = 'lighter';
        secondaryText = `(+${diffPercent}%)`;
      } else {
        primaryText = '‚ñº Darker';
        primaryClass = 'darker';
        secondaryText = `(${diffPercent}%)`;
      }
      
      result.innerHTML = `
        <div class="compare-primary ${primaryClass}">${primaryText}</div>
        <div class="compare-secondary">${secondaryText}</div>
      `;
      document.body.appendChild(result);
      
      // Reset for next comparison
      compareFirstPoint = null;
      hint.textContent = "Tap first area";
    }
  }

  // Add click handler to app
  document.querySelector('.app').addEventListener('click', handleCompareClick);

  document.getElementById("outlines-btn").onclick = () => {
    edgeMode = (edgeMode + 1) % 3;
    
    if (edgeMode === 0) {
      // Off
      showEdges = false;
      showSourceUnder = true;
      document.getElementById("edge-label").textContent = "Edges";
      document.getElementById("outlines-btn").classList.remove("active");
    } else if (edgeMode === 1) {
      // Edges only
      showEdges = true;
      showSourceUnder = false;
      document.getElementById("edge-label").textContent = "Edges Only";
      document.getElementById("outlines-btn").classList.add("active");
    } else {
      // Edges + Values
      showEdges = true;
      showSourceUnder = true;
      document.getElementById("edge-label").textContent = "Edge+Value";
      document.getElementById("outlines-btn").classList.add("active");
    }
  };

  document.getElementById("isolate-btn").onclick = () => {
    isolateActive = !isolateActive;
    document.getElementById("isolate-btn").classList.toggle("active", isolateActive);
    document.getElementById("isolate-box").style.display = isolateActive ? "block" : "none";
  };

  document.getElementById("flip-h-btn").onclick = () => {
    hFlip = !hFlip;
    applyTransform();
    document.getElementById("flip-h-btn").classList.toggle("active", hFlip);
  };

  document.getElementById("flip-v-btn").onclick = () => {
    vFlip = !vFlip;
    applyTransform();
    document.getElementById("flip-v-btn").classList.toggle("active", vFlip);
  };

  document.getElementById("grid-btn").onclick = () => {
    gridOn = !gridOn;
    document.getElementById("grid-btn").classList.toggle("active", gridOn);
    document.getElementById("grid-box").style.display = gridOn ? "block" : "none";
  };

  document.getElementById("grid-slider").oninput = (e) => {
    gridDivisions = parseInt(e.target.value);
    document.getElementById("grid-val").textContent = gridDivisions;
  };

  document.getElementById("histogram-btn").onclick = () => {
    document.getElementById("histogram-btn").classList.toggle("active");
  };

  document.getElementById("fullscreen-btn").onclick = () => {
    const fullscreenOverlay = document.getElementById("fullscreen-overlay");
    const fullscreenCanvas = document.getElementById("fullscreen-canvas");
    const ctx = fullscreenCanvas.getContext("2d");
    
    fullscreenCanvas.width = window.innerWidth;
    fullscreenCanvas.height = window.innerHeight;
    const w = fullscreenCanvas.width;
    const h = fullscreenCanvas.height;
    
    ctx.fillStyle = '#000';
    ctx.fillRect(0, 0, w, h);
    
    let sourceCanvas = massingTones > 0 && massing.style.display !== "none" ? massing : (imported ? frozen : video);
    const sw = sourceCanvas.videoWidth || sourceCanvas.width;
    const sh = sourceCanvas.videoHeight || sourceCanvas.height;
    
    if (sw && sh) {
      const scale = Math.min(w / sw, h / sh);
      const dw = sw * scale;
      const dh = sh * scale;
      ctx.drawImage(sourceCanvas, (w - dw) * 0.5, (h - dh) * 0.5, dw, dh);
    }
    
    if (overlay.width > 0) ctx.drawImage(overlay, 0, 0, w, h);
    
    fullscreenOverlay.classList.add("active");
  };

  document.getElementById("back-btn").onclick = () => {
    document.getElementById("fullscreen-overlay").classList.remove("active");
  };

  // ESC key to exit fullscreen
  document.addEventListener("keydown", (e) => {
    if (e.key === "Escape" || e.key === "Esc") {
      const fullscreenOverlay = document.getElementById("fullscreen-overlay");
      if (fullscreenOverlay.classList.contains("active")) {
        fullscreenOverlay.classList.remove("active");
      }
    }
  });

  document.getElementById("menu-btn").onclick = () => {
    document.getElementById("menu-modal").classList.add("active");
  };

  document.getElementById("how-to-toggle").onclick = () => {
    const content = document.getElementById("how-to-content");
    content.style.display = content.style.display === "none" ? "block" : "none";
  };

  document.getElementById("feedback-btn").onclick = () => {
    const emailDiv = document.getElementById("feedback-email");
    emailDiv.style.display = emailDiv.style.display === "none" ? "block" : "none";
  };

  document.getElementById("import-btn").onclick = () => document.getElementById("file-input").click();
  document.getElementById("file-input").onchange = (e) => {
    const reader = new FileReader();
    reader.onload = (ev) => {
      const img = new Image();
      img.onload = () => {
        imported = true;
        draw(ctxF, img, window.innerWidth, window.innerHeight);
        frozen.style.display = "block";
      };
      img.src = ev.target.result;
    };
    reader.readAsDataURL(e.target.files[0]);
  };

  document.getElementById("dim").oninput = (e) => { document.getElementById("dim-val").textContent = e.target.value + "%"; };
  document.getElementById("isolate-slider").oninput = (e) => {
    isolatedVal = parseInt(e.target.value);
    document.getElementById("val-num").textContent = isolatedVal;
  };

  document.getElementById("reset-btn").onclick = () => location.reload();

  document.getElementById("snapshot").onclick = () => {
    // Export at physical resolution using DPR
    const w = window.innerWidth * DPR;
    const h = window.innerHeight * DPR;
    
    const c = document.createElement('canvas');
    c.width = w;
    c.height = h;
    const ctx = c.getContext('2d');
    ctx.scale(DPR, DPR);
    
    const logicalW = window.innerWidth;
    const logicalH = window.innerHeight;
    
    // Draw current view at high resolution
    if (massingTones > 0 && massing.style.display !== "none") {
      ctx.drawImage(massing, 0, 0, logicalW, logicalH);
    } else {
      const source = imported ? frozen : video;
      ctx.drawImage(source, 0, 0, logicalW, logicalH);
    }
    
    // Draw overlay if present
    if (overlay.width > 0) {
      ctx.drawImage(overlay, 0, 0, logicalW, logicalH);
    }
    
    // Add watermark in lower right corner
    ctx.save();
    ctx.globalAlpha = 0.25;
    ctx.fillStyle = "#888";
    ctx.font = "21px system-ui";
    ctx.textAlign = "right";
    ctx.fillText("Value Mirror : Made by SidArtDesign ¬©", logicalW - 20, logicalH - 20);
    ctx.restore();
    
    const link = document.createElement('a');
    link.download = 'value_study.png';
    link.href = c.toDataURL();
    link.click();
  };

  window.addEventListener('resize', () => {
    resize(frozen);
    resize(massing);
    resize(overlay);
  });
</script>
</body>
</html>
