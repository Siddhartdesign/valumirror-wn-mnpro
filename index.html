<!DOCTYPE html>
<html lang="en">

  <head>
    <meta charset="UTF-8">
    <title>Untitled</title>
    

  </head>
    
  <body>
  <!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>ValueMirror Pro</title>
<style>
:root{
  --bg:#090909; --accent:#d4a373; --text:#fff; --ui-bg:rgba(15,15,15,0.95);
}
*{box-sizing:border-box; -webkit-tap-highlight-color:transparent;}
html,body{height:100%; margin:0; background:var(--bg); color:var(--text); font-family:-apple-system,system-ui,sans-serif; overflow:hidden;}
.app{position:relative; width:100vw; height:100vh;}
 
video, canvas { position:absolute; inset:0; width:100%; height:100%; object-fit:contain; }
#camera{z-index:1;}
#frozen{z-index:2; display:none;}
#massing{z-index:3; display:none;}
#overlay{z-index:4; pointer-events:none;}
 
.ui{
  position:absolute; inset:0; z-index:10; 
  display:flex; flex-direction:column; justify-content:space-between;
  pointer-events:none;
}
 
.top-bar {
  padding: 6px; display: flex; overflow-x: auto; gap: 6px; pointer-events:auto;
  background: linear-gradient(to bottom, rgba(0,0,0,0.9), transparent);
  scrollbar-width: none;
}
.top-bar::-webkit-scrollbar { display: none; }

.icon-btn{
  flex: 0 0 auto;
  background:rgba(255,255,255,0.12); border:1px solid rgba(255,255,255,0.1); border-radius:8px;
  width:60px; height:52px; display:flex; flex-direction:column; justify-content:center; align-items:center;
  cursor:pointer; color:#fff; transition: all 0.2s;
}
.wide { width: 72px; }

.icon-btn.active { background: var(--accent); color: #000; border-color: var(--accent); }
.icon-label{ font-size:8px; margin-top:3px; font-weight:800; text-transform:uppercase; text-align:center; line-height:1; }
 
.controls{
  pointer-events:auto; padding:12px; padding-bottom: calc(12px + env(safe-area-inset-bottom));
  background: var(--ui-bg); backdrop-filter:blur(25px);
  display:flex; flex-direction:column; gap:8px;
  border-top: 1px solid rgba(255,255,255,0.1);
}
 
.mode-group{ display:flex; background:rgba(255,255,255,0.05); padding:3px; border-radius:8px; }
.mode-group button{
  flex:1; border:none; background:transparent; padding:9px;
  border-radius:5px; font-size:11px; color:#888; cursor:pointer; font-weight:700;
}
.mode-group button.active{ background:#fff; color:#000; }

.tab-and-save-row{
  display:flex; gap:6px; align-items:stretch;
}
.mode-tabs{
  flex:1; display:flex; background:rgba(255,255,255,0.05); padding:3px; border-radius:8px; gap:2px;
}
.mode-tabs button{
  flex:1; border:none; background:transparent; padding:9px;
  border-radius:5px; font-size:11px; color:#888; cursor:pointer; font-weight:700;
  transition: all 0.15s;
}
.mode-tabs button.active{ background:#fff; color:#000; }

.save-btn-small{
  background:var(--accent); border:none; border-radius:8px;
  padding:9px 12px; font-weight:800; cursor:pointer; font-size:11px; color:#000;
  white-space:nowrap; min-width:70px;
}
 
.range-box { display:flex; flex-direction:column; gap:3px; }
.range-box label { display:flex; justify-content:space-between; font-size:9px; color:var(--accent); font-weight:800; }
.range{ width:100%; accent-color:var(--accent); height:24px; }

.fullscreen-overlay {
  position:fixed; inset:0; z-index:200; background:#000; display:none;
  align-items:center; justify-content:center;
}
.fullscreen-overlay.active { display:flex; }
.fullscreen-image { max-width:100%; max-height:100%; object-fit:contain; }
.back-btn {
  position:absolute; top:20px; left:20px; background:rgba(255,255,255,0.12);
  border:1px solid rgba(255,255,255,0.2); border-radius:8px; padding:12px 20px;
  color:rgba(255,255,255,0.6); font-size:13px; font-weight:700; cursor:pointer;
  transition: all 0.2s; opacity:0.7;
}
.back-btn:hover { background:rgba(255,255,255,0.2); color:rgba(255,255,255,0.9); opacity:1; }

.menu-modal{
  position:fixed; inset:0; z-index:100; display:none; background:rgba(0,0,0,0.85); backdrop-filter:blur(10px);
  align-items:center; justify-content:center; pointer-events:auto;
}
.menu-modal.active{ display:flex; }
.menu-content{
  background:var(--ui-bg); border-radius:16px; padding:24px; max-width:400px; width:90%;
  border:1px solid rgba(255,255,255,0.1); max-height:80vh; overflow-y:auto;
}
.menu-header{ font-size:20px; font-weight:800; color:var(--accent); margin-bottom:20px; text-align:center; }
.menu-section{ margin-bottom:20px; }
.menu-section-title{ font-size:16px; font-weight:800; color:#888; margin-bottom:12px; text-transform:uppercase; letter-spacing:0.5px; }
.menu-item{ font-size:14px; color:var(--accent); margin:10px 0; line-height:1.6; cursor:pointer; font-weight:700; }
.menu-item:hover{ opacity:0.8; }
.menu-divider{ height:1px; background:rgba(255,255,255,0.1); margin:16px 0; }
.close-menu-btn{
  background:var(--accent); border:none; border-radius:10px; padding:14px;
  font-weight:800; width:100%; cursor:pointer; font-size:13px; color:#000; margin-top:12px;
}
.expandable-content{ 
  max-height:0; overflow:hidden; transition:max-height 0.3s ease;
  margin-top:8px;
}
.expandable-content.open{ max-height:500px; }
.how-to-list{ margin-top:8px; padding-left:20px; }
.how-to-list li{ margin:8px 0; font-size:12px; color:#ddd; line-height:1.5; }
.how-to-note{ font-size:11px; color:#999; font-style:italic; margin-top:12px; line-height:1.5; }
.whats-new-list{ margin-top:10px; }
.feature-item{ 
  margin:10px 0; font-size:12px; color:#bbb; line-height:1.6; 
  padding-left:4px;
}

.compare-hint {
  position:absolute; top:80px; left:50%; transform:translateX(-50%);
  background:rgba(0,0,0,0.7); padding:8px 16px; border-radius:6px;
  font-size:13px; color:#aaa; pointer-events:none; opacity:0;
  transition: opacity 0.3s;
}
.compare-hint.show { opacity:1; }

.compare-dot {
  position:absolute; width:12px; height:12px; border-radius:50%;
  background:rgba(255,255,255,0.4); border:2px solid rgba(255,255,255,0.6);
  transform:translate(-50%, -50%); pointer-events:none; z-index:15;
}

.compare-result {
  position:absolute; background:rgba(0,0,0,0.85); padding:16px 20px;
  border-radius:10px; border:1px solid rgba(255,255,255,0.2);
  pointer-events:none; z-index:15; transform:translate(-50%, -120%);
  min-width:120px; text-align:center;
}
.compare-primary {
  font-size:24px; font-weight:900; margin-bottom:4px;
}
.compare-primary.lighter { color:#fff; }
.compare-primary.darker { color:#666; }
.compare-primary.same { color:#aaa; }
.compare-secondary {
  font-size:12px; color:#888; font-weight:400;
}
</style>
</head>
 
<body>
<div class="app">
  <video id="camera" autoplay playsinline muted></video>
  <canvas id="frozen"></canvas>
  <canvas id="massing"></canvas>
  <canvas id="overlay"></canvas>
 
  <div id="compare-hint" class="compare-hint">Tap first area</div>

  <div class="ui">
    <div class="top-bar">
        <button id="menu-btn" class="icon-btn">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M3 12h18M3 6h18M3 18h18"/></svg>
          <div class="icon-label">Menu</div>
        </button>
        <button id="import-btn" class="icon-btn wide">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" transform="scale(1,-1)"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M17 8l-5-5-5 5M12 3v12"/></svg>
          <div class="icon-label">Import</div>
        </button>
        <button id="simplify-btn" class="icon-btn wide">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="12" cy="12" r="10"/></svg>
          <div class="icon-label" id="squint-label">SQUINT: OFF</div>
        </button>
        <button id="compare-btn" class="icon-btn">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
            <circle cx="9" cy="12" r="6"/>
            <circle cx="15" cy="12" r="6"/>
          </svg>
          <div class="icon-label">Compare</div>
        </button>
        <button id="outlines-btn" class="icon-btn">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M12 3v18M3 12h18"/></svg>
          <div class="icon-label" id="edge-label">Edges</div>
        </button>
        <button id="flip-h-btn" class="icon-btn">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M4 12h16M8 6l-4 6 4 6"/></svg>
          <div class="icon-label">Flip H</div>
        </button>
        <button id="flip-v-btn" class="icon-btn">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M12 4v16M6 8l6-4 6 4"/></svg>
          <div class="icon-label">Flip V</div>
        </button>
        <button id="isolate-btn" class="icon-btn">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M12 2l3 6 7 1-5 5 1 7-6-3-6 3 1-7-5-5 7-1 3-6z"/></svg>
          <div class="icon-label">Isolate</div>
        </button>
        <button id="grid-btn" class="icon-btn">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M3 3h18v18H3zM9 3v18M15 3v18M3 9h18M3 15h18"/></svg>
          <div class="icon-label">Grid</div>
        </button>
        <button id="histogram-btn" class="icon-btn" style="display:none;">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M4 20V10M10 20V4M16 20v-6M22 20H2"/></svg>
          <div class="icon-label">Histogram</div>
        </button>
        <button id="fullscreen-btn" class="icon-btn wide">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"/></svg>
          <div class="icon-label">Fullscreen</div>
        </button>
        <button id="reset-btn" class="icon-btn">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M23 4v6h-6M1 20v-6h6"/></svg>
          <div class="icon-label">Reset</div>
        </button>
    </div>

    <div class="controls">
      <div class="tab-and-save-row">
        <div class="mode-tabs">
          <button id="mode-massing" class="active">Massing</button>
          <button id="mode-normal">Black & White</button>
          <button id="mode-color">Original</button>
        </div>
        <button id="snapshot" class="save-btn-small">SAVE</button>
      </div>
 
      <div class="range-box">
        <label>EXPOSURE <span id="dim-val">100%</span></label>
        <input id="dim" class="range" type="range" min="5" max="150" value="100">
      </div>

      <div class="range-box" id="isolate-box" style="display:none;">
        <label>TARGET TONE <span id="val-num">128</span></label>
        <input id="isolate-slider" class="range" type="range" min="0" max="255" value="128">
      </div>

      <div class="range-box" id="grid-box" style="display:none;">
        <label>GRID DIVISIONS <span id="grid-val">4</span></label>
        <input id="grid-slider" class="range" type="range" min="2" max="12" value="4">
      </div>
    </div>
  </div>
</div>

<div id="fullscreen-overlay" class="fullscreen-overlay">
  <canvas id="fullscreen-canvas" class="fullscreen-image"></canvas>
  <button id="back-btn" class="back-btn">Back</button>
</div>

<div id="menu-modal" class="menu-modal">
  <div class="menu-content">
    <div class="menu-header">VALUEMIRROR PRO</div>
    
    <div class="menu-section">
      <div class="menu-section-title">Help</div>
      <div class="menu-item" style="cursor:pointer;" id="how-to-toggle">• How to use</div>
      <div class="how-to-list" id="how-to-content" style="display:none;">
        <ol style="padding-left:20px; margin:0;">
          <li>Import an image or use the live camera</li>
          <li>Apply Massing to see clear value groupings</li>
          <li>Use the Dimmer to quiet brightness</li>
          <li>Use Squint to simplify values</li>
          <li>Use Isolation to highlight selected value ranges</li>
          <li>Use Compare to see which area is lighter, darker, or the same</li>
          <li>Save the image</li>
        </ol>
        <div class="how-to-note">~ Inspired by the Claude glass (black mirror), a darkened mirror used by painters in Europe during the 18th–19th century to reduce color and compress light, making value relationships easier to see.</div>
      </div>
    </div>

    <div class="menu-divider"></div>

    <div class="menu-section">
      <div class="menu-section-title">What's New in v2.0</div>
      <div class="whats-new-list">
        <div class="feature-item">• Added Squint mode with blur-based simplification levels</div>
        <div class="feature-item">• Added edge detection modes (Edges Only / Edge + Value)</div>
        <div class="feature-item">• Added value isolation targeting specific tones</div>
        <div class="feature-item">• Added adjustable grid overlay for reference drawing</div>
        <div class="feature-item">• Added vertical flip support</div>
        <div class="feature-item">• Expanded massing controls from 5 tones up to 10 tones</div>
        <div class="feature-item">• Added fullscreen analysis mode</div>
      </div>
    </div>

    <div class="menu-divider"></div>

    <div class="menu-section" style="display:none;">
      <div class="menu-section-title">Pro</div>
      <div class="menu-item">• Clean exports (no watermark)</div>
    </div>

    <div class="menu-section">
      <div class="menu-section-title">About</div>
      <div class="menu-item">• Version 2.0</div>
      <div class="menu-item" id="feedback-btn">• Send feedback</div>
      <div id="feedback-email" style="display:none; margin-top:8px; padding-left:16px; font-size:12px; color:#aaa; font-weight:400;">sidartdesignlab@gmail.com</div>
    </div>

    <button class="close-menu-btn" onclick="document.getElementById('menu-modal').classList.remove('active')">CLOSE</button>
  </div>
</div>
 
<input id="file-input" type="file" accept="image/*" style="display:none">
 
<script>
document.addEventListener("DOMContentLoaded", () => {
  const video = document.getElementById("camera"), frozen = document.getElementById("frozen");
  const massing = document.getElementById("massing"), overlay = document.getElementById("overlay");
  const ctxF = frozen.getContext("2d"), ctxM = massing.getContext("2d"), ctxO = overlay.getContext("2d");

  let imported = false, massingTones = 3, blurStep = 0, showEdges = false;
  let isolateActive = false, isolatedVal = 128, showSourceUnder = true;
  let hFlip = false, vFlip = false;
  let gridOn = false, gridDivisions = 4;
  let showColor = false;
  let edgeMode = 0; // 0=off, 1=edges only, 2=edges+values
  
  // Compare tool state
  let compareActive = false;
  let compareFirstPoint = null;

  const SQUINT_LEVELS = [0, 4, 10, 20, 40, 70];
  // Windows Store high-DPI compliance: Uses devicePixelRatio for proper scaling at 200% and other DPI settings
  const DPR = window.devicePixelRatio || 1; 

  async function initCam() {
    try {
      const s = await navigator.mediaDevices.getUserMedia({video: {facingMode: "environment", width: {ideal: 1920}}});
      video.srcObject = s;
    } catch(e) {
      console.warn("Camera access denied or not available:", e);
    }
  }

  function resize() {
    const w = window.innerWidth, h = window.innerHeight;
    [frozen, massing, overlay].forEach(c => { c.width = w; c.height = h; });
  }

  function applyTransform() {
    const sx = hFlip ? -1 : 1;
    const sy = vFlip ? -1 : 1;
    const t = `scale(${sx},${sy})`;
    [video, frozen, massing, overlay].forEach(el => el.style.transform = t);
  }

  function draw(ctx, src, w, h) {
    const sw = src.videoWidth || src.width, sh = src.videoHeight || src.height;
    if(!sw) return;
    ctx.fillStyle = '#000';
    ctx.fillRect(0, 0, w, h);
    const scale = Math.min(w/sw, h/sh);
    const dw = sw * scale;
    const dh = sh * scale;
    const dx = (w - dw) / 2;
    const dy = (h - dh) / 2;
    ctx.drawImage(src, dx, dy, dw, dh);
  }

  function drawGrid(w,h) {
    if(!gridOn) return;
    ctxO.save();
    ctxO.strokeStyle = 'rgba(255,255,255,0.18)';
    ctxO.lineWidth = 1;
    const stepX = w / gridDivisions;
    const stepY = h / gridDivisions;
    for(let i=1;i<gridDivisions;i++){
      ctxO.beginPath(); ctxO.moveTo(i*stepX,0); ctxO.lineTo(i*stepX,h); ctxO.stroke();
      ctxO.beginPath(); ctxO.moveTo(0,i*stepY); ctxO.lineTo(w,i*stepY); ctxO.stroke();
    }
    ctxO.restore();
  }

  function loop() {
    const w = window.innerWidth, h = window.innerHeight;
    const source = imported ? frozen : video;
    const dim = document.getElementById("dim").value;

    const filter = showColor ? `brightness(${dim}%)` : `grayscale(100%) brightness(${dim}%)`;
    video.style.filter = filter;
    frozen.style.filter = filter;
    
    const hideUnder = (!showSourceUnder && (showEdges || isolateActive));
    video.style.opacity = hideUnder ? 0 : 1;
    frozen.style.opacity = hideUnder ? 0 : 1;

    ctxO.clearRect(0,0,w,h);

    if (massingTones > 0 || blurStep > 0 || showEdges || isolateActive) {
      massing.style.display = "block";
      ctxM.filter = blurStep > 0 ? `blur(${SQUINT_LEVELS[blurStep]}px)` : 'none';
      draw(ctxM, source, w, h);
      ctxM.filter = 'none';

      // Process the entire canvas for massing effect
      if (massingTones > 0) {
        let imgData = ctxM.getImageData(0,0,w,h);
        let d = imgData.data;
        let step = 255 / massingTones;
        for (let i=0; i<d.length; i+=4) {
          let v = 0.299*d[i] + 0.587*d[i+1] + 0.114*d[i+2];
          d[i] = d[i+1] = d[i+2] = Math.floor(v/step)*step;
        }
        ctxM.putImageData(imgData, 0, 0);
      }

      if (showEdges || isolateActive) {
        let imgData = ctxM.getImageData(0,0,w,h);
        let d = imgData.data;
        const outData = ctxO.createImageData(w, h);
        const out = outData.data;
        for (let i=0; i<d.length; i+=4) {
          if (showEdges && i % (w*4) < (w-1)*4) {
             if (Math.abs(d[i] - d[i+4]) > 22) { out[i]=out[i+1]=out[i+2]=255; out[i+3]=220; }
          }
          if (isolateActive && Math.abs(d[i] - isolatedVal) < 18) {
             out[i]=212; out[i+1]=163; out[i+2]=115; out[i+3]=255;
          }
        }
        ctxO.putImageData(outData, 0, 0);
      }
      massing.style.filter = `brightness(${dim}%)`;
      massing.style.opacity = hideUnder ? 0 : 1;
    } else {
      massing.style.display = "none";
    }

    drawGrid(w,h);
    requestAnimationFrame(loop);
  }

  document.getElementById("mode-massing").onclick = () => {
    massingTones = (massingTones < 2) ? 3 : (massingTones >= 10 ? 2 : massingTones + 1);
    showColor = false;
    document.getElementById("mode-massing").classList.add("active");
    document.getElementById("mode-normal").classList.remove("active");
    document.getElementById("mode-color").classList.remove("active");
    document.getElementById("mode-massing").textContent = massingTones + " Tones";
  };

  document.getElementById("mode-normal").onclick = () => {
    massingTones = 0;
    showColor = false;
    document.getElementById("mode-normal").classList.add("active");
    document.getElementById("mode-massing").classList.remove("active");
    document.getElementById("mode-color").classList.remove("active");
    document.getElementById("mode-massing").textContent = "Massing";
  };

  document.getElementById("mode-color").onclick = () => {
    massingTones = 0;
    showColor = true;
    document.getElementById("mode-color").classList.add("active");
    document.getElementById("mode-normal").classList.remove("active");
    document.getElementById("mode-massing").classList.remove("active");
    document.getElementById("mode-massing").textContent = "Massing";
  };

  document.getElementById("simplify-btn").onclick = () => {
    blurStep = (blurStep + 1) % SQUINT_LEVELS.length;
    document.getElementById("squint-label").textContent = blurStep === 0 ? "SQUINT: OFF" : "SQUINT: " + blurStep;
    document.getElementById("simplify-btn").classList.toggle("active", blurStep > 0);
  };

  document.getElementById("compare-btn").onclick = () => {
    compareActive = !compareActive;
    document.getElementById("compare-btn").classList.toggle("active", compareActive);
    
    const hint = document.getElementById("compare-hint");
    
    if (compareActive) {
      hint.textContent = "Tap first area";
      hint.classList.add("show");
    } else {
      // Exit - clear everything
      compareFirstPoint = null;
      clearCompareDots();
      hint.classList.remove("show");
    }
  };

  function clearCompareDots() {
    document.querySelectorAll('.compare-dot').forEach(el => el.remove());
    document.querySelectorAll('.compare-result').forEach(el => el.remove());
  }

  function getValueAtPoint(x, y) {
    const canvas = massingTones > 0 && massing.style.display !== "none" ? massing : (imported ? frozen : video);
    const tempCanvas = document.createElement('canvas');
    tempCanvas.width = 1;
    tempCanvas.height = 1;
    const ctx = tempCanvas.getContext('2d');
    ctx.drawImage(canvas, x, y, 1, 1, 0, 0, 1, 1);
    const pixel = ctx.getImageData(0, 0, 1, 1).data;
    return 0.299 * pixel[0] + 0.587 * pixel[1] + 0.114 * pixel[2];
  }

  function handleCompareClick(e) {
    if (!compareActive) return;
    
    const rect = e.currentTarget.getBoundingClientRect();
    const x = e.clientX - rect.left;
    const y = e.clientY - rect.top;
    
    const hint = document.getElementById("compare-hint");
    
    if (!compareFirstPoint) {
      // Clear previous comparison before starting new one
      clearCompareDots();
      
      // First tap
      compareFirstPoint = { x, y, value: getValueAtPoint(x, y) };
      
      const dot = document.createElement('div');
      dot.className = 'compare-dot';
      dot.style.left = e.clientX + 'px';
      dot.style.top = e.clientY + 'px';
      document.body.appendChild(dot);
      
      hint.textContent = "Tap second area";
      
    } else {
      // Second tap - show result
      const secondValue = getValueAtPoint(x, y);
      const diff = secondValue - compareFirstPoint.value;
      const diffPercent = Math.round((diff / 255) * 100);
      
      // Add second dot (keep first dot visible)
      const dot = document.createElement('div');
      dot.className = 'compare-dot';
      dot.style.left = e.clientX + 'px';
      dot.style.top = e.clientY + 'px';
      document.body.appendChild(dot);
      
      // Show result near second dot
      const result = document.createElement('div');
      result.className = 'compare-result';
      result.style.left = e.clientX + 'px';
      result.style.top = e.clientY + 'px';
      
      let primaryText, primaryClass, secondaryText;
      if (Math.abs(diffPercent) <= 2) {
        primaryText = '■ Same';
        primaryClass = 'same';
        secondaryText = '(≈0%)';
      } else if (diff > 0) {
        primaryText = '▲ Lighter';
        primaryClass = 'lighter';
        secondaryText = `(+${diffPercent}%)`;
      } else {
        primaryText = '▼ Darker';
        primaryClass = 'darker';
        secondaryText = `(${diffPercent}%)`;
      }
      
      result.innerHTML = `
        <div class="compare-primary ${primaryClass}">${primaryText}</div>
        <div class="compare-secondary">${secondaryText}</div>
      `;
      document.body.appendChild(result);
      
      // Reset for next comparison
      compareFirstPoint = null;
      hint.textContent = "Tap first area";
    }
  }

  // Add click handler to app
  document.querySelector('.app').addEventListener('click', handleCompareClick);

  document.getElementById("outlines-btn").onclick = () => {
    edgeMode = (edgeMode + 1) % 3;
    
    if (edgeMode === 0) {
      // Off
      showEdges = false;
      showSourceUnder = true;
      document.getElementById("edge-label").textContent = "Edges";
      document.getElementById("outlines-btn").classList.remove("active");
    } else if (edgeMode === 1) {
      // Edges only
      showEdges = true;
      showSourceUnder = false;
      document.getElementById("edge-label").textContent = "Edges Only";
      document.getElementById("outlines-btn").classList.add("active");
    } else {
      // Edges + Values
      showEdges = true;
      showSourceUnder = true;
      document.getElementById("edge-label").textContent = "Edge+Value";
      document.getElementById("outlines-btn").classList.add("active");
    }
  };

  document.getElementById("isolate-btn").onclick = () => {
    isolateActive = !isolateActive;
    document.getElementById("isolate-btn").classList.toggle("active", isolateActive);
    document.getElementById("isolate-box").style.display = isolateActive ? "block" : "none";
  };

  document.getElementById("flip-h-btn").onclick = () => {
    hFlip = !hFlip;
    applyTransform();
    document.getElementById("flip-h-btn").classList.toggle("active", hFlip);
  };

  document.getElementById("flip-v-btn").onclick = () => {
    vFlip = !vFlip;
    applyTransform();
    document.getElementById("flip-v-btn").classList.toggle("active", vFlip);
  };

  document.getElementById("grid-btn").onclick = () => {
    gridOn = !gridOn;
    document.getElementById("grid-btn").classList.toggle("active", gridOn);
    document.getElementById("grid-box").style.display = gridOn ? "block" : "none";
  };

  document.getElementById("grid-slider").oninput = (e) => {
    gridDivisions = parseInt(e.target.value);
    document.getElementById("grid-val").textContent = gridDivisions;
  };

  document.getElementById("histogram-btn").onclick = () => {
    document.getElementById("histogram-btn").classList.toggle("active");
  };

  document.getElementById("fullscreen-btn").onclick = () => {
    const fullscreenOverlay = document.getElementById("fullscreen-overlay");
    const fullscreenCanvas = document.getElementById("fullscreen-canvas");
    const ctx = fullscreenCanvas.getContext("2d");
    
    fullscreenCanvas.width = window.innerWidth;
    fullscreenCanvas.height = window.innerHeight;
    const w = fullscreenCanvas.width;
    const h = fullscreenCanvas.height;
    
    ctx.fillStyle = '#000';
    ctx.fillRect(0, 0, w, h);
    
    let sourceCanvas = massingTones > 0 && massing.style.display !== "none" ? massing : (imported ? frozen : video);
    const sw = sourceCanvas.videoWidth || sourceCanvas.width;
    const sh = sourceCanvas.videoHeight || sourceCanvas.height;
    
    if (sw && sh) {
      const scale = Math.min(w / sw, h / sh);
      const dw = sw * scale;
      const dh = sh * scale;
      ctx.drawImage(sourceCanvas, (w - dw) * 0.5, (h - dh) * 0.5, dw, dh);
    }
    
    if (overlay.width > 0) ctx.drawImage(overlay, 0, 0, w, h);
    
    fullscreenOverlay.classList.add("active");
  };

  document.getElementById("back-btn").onclick = () => {
    document.getElementById("fullscreen-overlay").classList.remove("active");
  };

  // ESC key to exit fullscreen
  document.addEventListener("keydown", (e) => {
    if (e.key === "Escape" || e.key === "Esc") {
      const fullscreenOverlay = document.getElementById("fullscreen-overlay");
      if (fullscreenOverlay.classList.contains("active")) {
        fullscreenOverlay.classList.remove("active");
      }
    }
  });

  document.getElementById("menu-btn").onclick = () => {
    document.getElementById("menu-modal").classList.add("active");
  };

  document.getElementById("how-to-toggle").onclick = () => {
    const content = document.getElementById("how-to-content");
    content.style.display = content.style.display === "none" ? "block" : "none";
  };

  document.getElementById("feedback-btn").onclick = () => {
    const emailDiv = document.getElementById("feedback-email");
    emailDiv.style.display = emailDiv.style.display === "none" ? "block" : "none";
  };

  document.getElementById("import-btn").onclick = () => document.getElementById("file-input").click();
  document.getElementById("file-input").onchange = (e) => {
    const reader = new FileReader();
    reader.onload = (ev) => {
      const img = new Image();
      img.onload = () => {
        imported = true;
        draw(ctxF, img, window.innerWidth, window.innerHeight);
        frozen.style.display = "block";
      };
      img.src = ev.target.result;
    };
    reader.readAsDataURL(e.target.files[0]);
  };

  document.getElementById("dim").oninput = (e) => { document.getElementById("dim-val").textContent = e.target.value + "%"; };
  document.getElementById("isolate-slider").oninput = (e) => {
    isolatedVal = parseInt(e.target.value);
    document.getElementById("val-num").textContent = isolatedVal;
  };

  document.getElementById("reset-btn").onclick = () => location.reload();

  document.getElementById("snapshot").onclick = () => {
    // Export at physical resolution using DPR
    const w = window.innerWidth * DPR;
    const h = window.innerHeight * DPR;
    
    const c = document.createElement('canvas');
    c.width = w;
    c.height = h;
    const ctx = c.getContext('2d');
    ctx.scale(DPR, DPR);
    
    const logicalW = window.innerWidth;
    const logicalH = window.innerHeight;
    
    // Draw current view at high resolution
    if (massingTones > 0 && massing.style.display !== "none") {
      ctx.drawImage(massing, 0, 0, logicalW, logicalH);
    } else {
      const source = imported ? frozen : video;
      ctx.drawImage(source, 0, 0, logicalW, logicalH);
    }
    
    // Draw overlay if present
    if (overlay.width > 0) {
      ctx.drawImage(overlay, 0, 0, logicalW, logicalH);
    }
    
    // Add watermark in lower right corner
    ctx.save();
    ctx.globalAlpha = 0.25;
    ctx.fillStyle = "#888";
    ctx.font = "21px system-ui";
    ctx.textAlign = "right";
    ctx.fillText("Value Mirror : Made by SidArtDesign ©", logicalW - 20, logicalH - 20);
    ctx.restore();
    
    const link = document.createElement('a');
    link.download = 'value_study.png';
    link.href = c.toDataURL();
    link.click();
  };

  window.addEventListener("resize", resize);
  resize(); initCam(); loop();
  
  // Initialize massing button text
  document.getElementById("mode-massing").textContent = massingTones + " Tones";
});
</script>
</body>
</html>
    
  </body>
  
</html>
